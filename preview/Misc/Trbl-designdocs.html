<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-us">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8"><meta name="copyright" content="(C) Copyright 2015">
<meta name="DC.rights.owner" content="(C) Copyright 2015">
<meta name="DC.Type" content="topic">
<meta name="DC.Relation" scheme="URI" content="../Misc/Trbl-intro.html">
<meta name="DC.Relation" scheme="URI" content="../Misc/Trbl-datamissing-user.html">
<meta name="DC.Relation" scheme="URI" content="../Misc/Trbl-expireddocs.html">
<meta name="DC.Relation" scheme="URI" content="../Views/views-intro.html">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="topic4336">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../commonltr.css">
<title>Design document aliases</title>
</head>
<body id="topic4336">


   <h1 class="title topictitle1">Design document aliases</h1>

   <div class="body">
      <p class="p">When two (2) or more design documents have exactly the same map and reduce functions (but
         different IDs), they get the same signature. This means that both point to the
         same index files, which enables publishing of development design
         documents into production. In production, a copy of the development design
         document is created (ID matches _design/dev_foobar) with an ID not containing the
            <samp class="ph codeph">dev_</samp> prefix, and then the original development document is deleted 
         making suire that the index files are preserved after deleting the development design document. It’s
         also possible to have multiple “production” aliases for the same production design
         document. The view engine itself has no notion of development and production design
         documents, this is a notion only at the UI and cluster layers, which exploits the design
         document signatures/aliases feature.</p>

      <p class="p">The following example shows this property.</p>

      <p class="p">We create two (2) identical design documents, only their IDs differ:</p>

      <pre class="pre codeblock"><samp class="ph codeph">&gt; curl -H 'Content-Type: application/json' \
    -X PUT 'http://localhost:9500/default/_design/ddoc1' \
    -d '{ "views": {"view1": {"map": "function(doc, meta) { emit(doc.level, meta.id); }"}}}'
{"ok":true,"id":"_design/ddoc1"}

&gt; curl -H 'Content-Type: application/json' \
    -X PUT 'http://localhost:9500/default/_design/ddoc2'
    -d '{ "views": {"view1": {"map": "function(doc, meta) { emit(doc.level, meta.id); }"}}}'
{"ok":true,"id":"_design/ddoc2"}
</samp></pre>

      <p class="p">Next we query view1 from _design/ddoc1 with <samp class="ph codeph">stale=false</samp>, and get:</p>

      <pre class="pre codeblock"><samp class="ph codeph">&gt; curl -s 'http://localhost:9500/default/_design/ddoc1/_view/view1?limit=10&amp;stale=false'
{"total_rows":1000000,"rows":[
{"id":"0000025","key":1,"value":"0000025"},
{"id":"0000136","key":1,"value":"0000136"},
{"id":"0000158","key":1,"value":"0000158"},
{"id":"0000205","key":1,"value":"0000205"},
{"id":"0000208","key":1,"value":"0000208"},
{"id":"0000404","key":1,"value":"0000404"},
{"id":"0000464","key":1,"value":"0000464"},
{"id":"0000496","key":1,"value":"0000496"},
{"id":"0000604","key":1,"value":"0000604"},
{"id":"0000626","key":1,"value":"0000626"}
]
}
</samp></pre>

      <p class="p">If immediately after you query view1 from _design/ddoc2 with <samp class="ph codeph">stale=ok</samp>,
         you’ll get exactly the same results, because both design documents are aliases, they share
         the same signature:</p>

      <pre class="pre codeblock"><samp class="ph codeph">&gt; curl -s 'http://localhost:9500/default/_design/ddoc2/_view/view1?limit=10&amp;stale=ok'
{"total_rows":1000000,"rows":[
{"id":"0000025","key":1,"value":"0000025"},
{"id":"0000136","key":1,"value":"0000136"},
{"id":"0000158","key":1,"value":"0000158"},
{"id":"0000205","key":1,"value":"0000205"},
{"id":"0000208","key":1,"value":"0000208"},
{"id":"0000404","key":1,"value":"0000404"},
{"id":"0000464","key":1,"value":"0000464"},
{"id":"0000496","key":1,"value":"0000496"},
{"id":"0000604","key":1,"value":"0000604"},
{"id":"0000626","key":1,"value":"0000626"}
]
}
</samp></pre>

      <p class="p">If you look into the data directory, there’s only one main index file and one replica index
         file:</p>

      <pre class="pre codeblock"><samp class="ph codeph">&gt; tree couch/0/\@indexes
couch/0/@indexes
 ??? default
     ???
main_1909e1541626269ef88c7107f5123feb.view.1
     ???
replica_1909e1541626269ef88c7107f5123feb.view.1
     ???
tmp_1909e1541626269ef88c7107f5123feb_main

 2 directories, 2 files
</samp></pre>

      <p class="p">Also, while the indexer is running, if you query <samp class="ph codeph">_active_tasks</samp> for a node,
         you’ll see one single indexer task, which lists both design documents in the
            <samp class="ph codeph">design_documents</samp> array field:</p>

      <pre class="pre codeblock">
&gt; curl -s http://localhost:9500/_active_tasks | json_xs
[
   {
      "waiting" : 0,
      "started_on" : 1345662986,
      "pid" :   "&lt;0.234.0&gt;",
      "type" :   "couch_main_index_barrier",
      "running" : 1,
      "limit" : 4,
      "updated_on" : 1345663590
   },
   {
      "waiting" : 0,
      "started_on" : 1345662986,
      "pid" : "&lt;0.235.0&gt;",
      "type" :   "couch_replica_index_barrier",
      "running" : 0,
      "limit" : 2,
      "updated_on" : 1345662986
   },
   {
      "indexer_type" : "main",
      "started_on" : 1345663590,
      "progress" : 75,
      "initial_build" : true,
      "updated_on" : 1345663634,
      "total_changes" : 250000,
      "design_documents" : [
         "_design/ddoc1",
         "_design/ddoc2"
      ],
      "pid" :   "&lt;0.6567.0&gt;",
      "changes_done" : 189635,
      "signature" : "1909e1541626269ef88c7107f5123feb",
      "type" :   "indexer",
      "set" :   "default"
   }
]
</pre>

   </div>

   <nav class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../Misc/Trbl-intro.html" title="トラブルシューティングの一般的なヒント、一般的なエラー、ログ情報、およびその他の問題について説明します。">トラブルシューティング</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../Misc/Trbl-datamissing-user.html" title="Data missing in query response or it’s wrong (user issue)">Incorrect or missing data (user issue)</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../Misc/Trbl-expireddocs.html" title="Expired documents have their associated key-value pairs returned in queries with stale=false.">Expired documents issue</a></div>
</div>

<div class="linklist linklist">
<div><a class="link" href="../Views/views-intro.html" title="Couchbase views enable indexing and querying of data.">Views and indexes</a></div></div>
</nav>

</body>
</html>