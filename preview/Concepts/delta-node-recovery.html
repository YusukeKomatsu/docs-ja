<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="ja">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8"><meta name="copyright" content="(C) Copyright 2015">
<meta name="DC.rights.owner" content="(C) Copyright 2015">
<meta name="DC.Type" content="topic">
<meta name="description" content="デルタノードリカバリを使うと、ノードをクラスタに再追加後に、変更されたデータの差分を反映させることができます。"><meta name="DC.Relation" scheme="URI" content="../Tasks/recovery-failover-nodes.html">
<meta name="DC.Relation" scheme="URI" content="../Tasks/recovery-full-recovery.html">
<meta name="DC.Relation" scheme="URI" content="graceful-failover.html">
<meta name="DC.Relation" scheme="URI" content="../CLI/CBcli/cbcli-servers.html">
<meta name="DC.Relation" scheme="URI" content="../REST/rest-server-nodes.html">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="topic_s15_tlh_14">
<meta name="DC.Language" content="ja">
<link rel="stylesheet" type="text/css" href="../commonltr.css">
<title>デルタノードリカバリ</title>
</head>
<body id="topic_s15_tlh_14">


  <h1 class="title topictitle1">デルタノードリカバリ</h1>

  
  
  <div class="body"><p class="shortdesc">
	  デルタノードリカバリを使うと、ノードをクラスタに再追加後に、変更されたデータの差分を反映させることができます。
  </p>

  	
	<p class="p">
		デルタノードリカバリは、フェイルオーバしたノードのディスク上にあるデータを再利用し、差分の変更を反映し再同期させることで、リカバリが可能です。
		フェイルオーバしたノードはどの時点でデータの変化が停止したのかを特定するためにチェックされ、その時点から再同期を開始します。
		サーバノードは保持するvBucketのデータ変化を反映した後、データの提供を開始します。
		元々のデータとバケットを再利用することで、最小のダウンタイムでクラスタの利用を開始できます。
		この操作により、リカバリ時間とネットワークリソース利用が向上します。
    </p>

    
	<p class="p">
		サーバノードは様々な場面でクラスタから削除されます。
		以下の例は、サーバノードをクラスタからフェイルオーバした後に再追加する場面の一部を示しています(この他にも多くあります)。
    </p>

    
    <ul class="ul">
      <li class="li">ノードが少しの間ダウンした</li>

      <li class="li">計画的定期メンテナンス</li>

      <li class="li">ネットワーク接続が少しの間切断した</li>

    </ul>

      
	<p class="p">
		ノードがフェイルオーバされても、データファイルは保持されます。
		データファイルはCouchbaseサポートにも、データの復旧にも、デルタノードリカバリにも利用できます。
	</p>

    
	<p class="p">
		ノードをフェイルオーバし、メンテナンスを行い、ノードをクラスタへ再追加して、リバランスを実行する処理において、
		フルリカバリモードかデルタリカバリモードでデータを復旧することができます。
		デルタリカバリモードでは、Couchbaseが(DCPを利用し)、どのデータファイルが最新で、どのデータファイルが古くなっているかを検知し、
		リバランス時に、フェイルオーバしたサーバノード上の既存のデータファイルを再利用し、古くなったファイルを更新します。
	</p>

    
	<p class="p">
		サーバノードをフェイルオーバすると、Webコンソールに、Delta RecoveryとFull Recoveryの選択肢が表示されます。
		いずれの復旧方法もサーバをクラスタに再追加するためにリバランスが必要ですが、
		フルリカバリの場合、リバランス前にノードが持つ既存データを削除するのに対し、デルタリカバリではノードが持つ既存データを再利用します。
    </p>

    
    
    
    <p class="p">デルタリカバリの条件:</p>

    <ul class="ul">
      <li class="li">ノードとクラスタが健全な状態である必要があります。</li>

	  <li class="li">
		  フェイルオーバしたサーバノードが必要です。
		  デルタリカバリはサーバ追加時のリバランス、およびサーバ削除時のリバランスでは利用できません。
	  </li>

	  <li class="li">
		  すべてのバケットでデルタリカバリが実行できる必要があります。
		  例えば、いくつかのバケットがデルタリカバリ可能でも、それ以外のバケットが不可能であった場合、
		  Couchbaseクラスタはリバランス操作を許可しません。
	  </li>

	  <li class="li">
		  なぜなら、デルタリカバリはフェイルオーバしたサーバノードのディスク上にある既存のデータファイルに依存しており、
		  それと完全に同じセットのバケットを、フェイルオーバしたサーバノードに転送する必要があるからです。
	  </li>

    </ul>

    
    <p class="p">デルタリカバリの性質:</p>

    <ul class="ul">
		<li class="li">
			データファイルはメモリ上に"ウォームアップ"されます。
			メモリへのウォームアップとはデータをメモリ上にロードすることです。
			どのメタデータが保持されるかによって、必要最小のすべてのデータファイルキーがリバランス操作の前にディスクからロードされます。
		</li>

      <li class="li">インデックスは再追加するサーバノード上で必ず再構築されます。</li>

	  <li class="li">
		  データサイズがRAMサイズよりもはるかに大きく、バケットでfull eviction(メタデータをメモリに保持しない)を設定していて、
		  インデックスを定義していない環境で利用してください。
		</li>

    </ul>


    
	<div class="note tip"><span class="tiptitle">ヒント:</span> 
		非常に大きなデータ量を保持する環境で、フェイルオーバしたサーバノードを再追加する場合に利用できます。
	</div>

    

 
 
    <div class="section"><h2 class="title sectiontitle">デルタノードリカバリが利用できないシナリオ</h2>
      
		<p class="p">
			以下の条件は、デルタノードリカバリが利用できず、フルリカバリとなる条件です:
		</p>

      <ul class="ul">
		  <li class="li">
			ノードがデルタリカバリ待ちの間にトポロジが変わった場合、デルタノードリカバリに影響します。
			例えば、他のノードを追加したり、ノードを削除したり、ノードをスワップするなどです。
          </li>

        <li class="li">ダウンしたノードがハードフェイルオーバされ、削除待ちの場合。</li>

		<li class="li">
			リバランスにより異なる数のノード追加、削除が実行された場合(スワップリバランスは実行可能です)。
		</li>

		<li class="li">
			ノードがデルタリカバリ待ちの間に、デルタノードリカバリに影響するバケット操作を行った場合。
			例えば、新規のバケットを追加したり、バケットのレプリカ設定を変更したり、バケットをフラッシュするなどです。
		</li>

      </ul>

      

	  <p class="p">
		以下は、デルタノードリカバリが利用できず、フルリカバリとなるシナリオです:
		</p>

      
      <p class="p">Node 1をデルタリカバリ中にアクティブなサーバノードのNode 2がクラッシュ。</p>

      <ol class="ol">
		  <li class="li">Node 1のフェイルオーバ後、デルタリカバリを指定。Node 1はデルタリカバリ待ちの状態。</li>

		  <li class="li">そこでアクティブサーバのNode 2がダウン。<div class="note note"><span class="notetitle">注:</span> リバランスを実行することはできません。</div>
</li>

            <li class="li">Node 2をフェイルオーバ。 </li>

            <li class="li">ペンディング中のデルタリカバリをキャンセルし、フルリカバリを指定してリバランス。</li>

            <li class="li">Node 2を修復し、クラスタに追加してリバランス。</li>

          </ol>

       
      <p class="p">Node 1をデルタリカバリし、リバランス中にNode 1がクラッシュ。</p>

      
      <ol class="ol">
            <li class="li">Node 1のフェイルオーバ後、デルタリカバリを指定し、リバランスを開始。</li>

			<li class="li">Node 1がクラッシュし、リバランスが失敗。</li>

			<li class="li">Node 1を修復、サーバノードを再起動し、リバランス。Node 1をフルリカバリにより再追加。
			</li>

          </ol>

        
        <p class="p">Node 1のデルタリカバリ時にバケットに対して操作を実行。</p>

		<p class="p">リバランスの失敗するバケットの操作は、バケットの追加、レプリカ設定の変更、バケットのフラッシュです。</p>

      <ol class="ol">
            <li class="li">Node 1のフェイルオーバ後、デルタリカバリを指定、その後バケットに上記操作が行われた。</li>

            <li class="li">リバランスを実行すると失敗。<p class="p"><img class="image" src="../images/ui-delta-rebalance-not-available.png" width="360"></p>
</li>

            <li class="li">ペンディング中のデルタリカバリをキャンセルし、フルリカバリを指定、リバランス。</li>

          </ol>

          <div class="note note"><span class="notetitle">注:</span> バケットの削除はデルタリカバリを継続できます。</div>

        
        
        <p class="p">Node 1とNode 2をデルタリカバリ中にNode 2がクラッシュ。</p>

          <ol class="ol">
            <li class="li">Node1とNode 2いずれもフェイルオーバ後、デルタリカバリを指定。</li>

            <li class="li">Node 2がクラッシュ。</li>

            <li class="li">リバランスを実行すると失敗。 <p class="p"><img class="image" src="../images/ui-rebalance-failed.png" width="480"></p>
</li>

          </ol>

      
     
    </div>

    
    
    
  </div>

  
  <nav class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>親トピック:</strong> <a class="link" href="../Tasks/recovery-failover-nodes.html" title="The options for recovering failed over nodes are delta node recovery and full recovery.">Recovering failed over nodes</a></div>
<div class="nextlink"><strong>次のトピック:</strong> <a class="link" href="../Tasks/recovery-full-recovery.html" title="With full recovery mode, the data files are removed from the failed over server node and then, during rebalance, the node is populated with new data files (active and replica vBuckets).">Full recovery</a></div>
</div>

<div class="linklist linklist">
<div><a class="link" href="graceful-failover.html" title="グレイスフルフェイルオーバは、実行中の操作が完了した後に、データを失うことなく、管理者が安全にノードをクラスタからフェイルオーバする方法を提供します。">グレイスフルフェイルオーバ</a></div>
<div><a class="link" href="../CLI/CBcli/cbcli-servers.html" title="Managing server nodes in a cluster involve a variety of couchbase-cli tool commands.">Server nodes</a></div>
<div><a class="link" href="../REST/rest-server-nodes.html" title="The Server Nodes REST API manages nodes in a cluster.">Server nodes API</a></div></div>
</nav>

</body>
</html>