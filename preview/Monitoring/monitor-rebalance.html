<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-us">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8"><meta name="copyright" content="(C) Copyright 2015">
<meta name="DC.rights.owner" content="(C) Copyright 2015">
<meta name="DC.Type" content="topic">
<meta name="description" content="Monitoring of the system during and immediately after rebalancing is needed until replication is completed successfully."><meta name="DC.Relation" scheme="URI" content="../Monitoring/monitor-intro.html">
<meta name="DC.Relation" scheme="URI" content="../Monitoring/monitor-warmup.html">
<meta name="DC.Relation" scheme="URI" content="../REST/rest-cluster-rebalance.html">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="topic_rnp_cyf_q4">
<link rel="stylesheet" type="text/css" href="../commonltr.css">
<title>Monitoring a rebalance operation</title>
</head>
<body id="topic_rnp_cyf_q4">


  <h1 class="title topictitle1">Monitoring a rebalance operation</h1>

  
  <div class="body"><p class="shortdesc">Monitoring of the system during and
    immediately after rebalancing is needed until replication is completed
    successfully.</p>

    <p class="p">As Couchbase Server
      moves vBuckets within the cluster, Couchbase Web Console provides a detailed rebalancing report. You can view the same
        statistics via a REST API call. If you click on the drop-down list next to each node, you can view the
        detailed rebalance status:</p>

  
          <div class="fig fignone"><img class="image" src="../images/rebalance_detail_report.png" width="720"></div>


    
    <p class="p">The section <span class="keyword wintitle">Data being transferred out</span> shows that a
          node sends data to other nodes during rebalance.</p>

         <p class="p">The section <span class="keyword wintitle">Data being transferred in</span> shows that a node receives data from other nodes during rebalance.</p>

      <p class="p">A node can be a source, a destination, or both the source and the destination for data. The progress report
          displays the following information:</p>

    
    <ul class="ul">
            <li class="li"><strong class="ph b">Bucket</strong>: Name of bucket undergoing rebalance. Number of buckets transferred during
              rebalancing out of total buckets in a cluster.</li>

            <li class="li"><strong class="ph b">Total number of keys</strong>: Total number of keys to be transferred during 
              rebalancing.</li>

            <li class="li"><strong class="ph b">Estimated number of keys</strong>: Number of keys transferred during rebalancing.</li>

            <li class="li"><strong class="ph b">Number of Active# vBuckets and Replica# vBuckets</strong>: Number of active vBuckets and
              replica vBuckets to be transferred as part of rebalancing.</li>

          </ul>

    
    <p class="p">You can also use <samp class="ph codeph">cbstats</samp> to see underlying rebalance statistics.</p>

    
    <div class="section"><h2 class="title sectiontitle">Backfilling</h2>
      <p class="p">The first stage of replication reads all data for a given active vBucket and sends it to
        the server that is responsible for the replica. This can put increased load on the disk as
        well as network bandwidth, but it is not designed to impact any client activity. You can
        monitor the progress of this task by watching for ongoing TAP disk fetches. You can also
        watch <samp class="ph codeph">cbstats tap</samp>, for example:</p>

      
      <pre class="pre codeblock">cbstats &lt;node_IP&gt;:11210 -b bucket_name -p bucket_password tap | grep backfill</pre>

      
      <p class="p">This returns a list of TAP backfill processes and whether they are still running (<samp class="ph codeph">true</samp>) or done
        (<samp class="ph codeph">false</samp>). During the backfill process for a particular TAP stream, the output is as
        follows:</p>
<pre class="pre codeblock"><samp class="ph codeph">eq_tapq:replication_building_485_'n_1@127.0.0.1':backfill_completed: false
 eq_tapq:replication_building_485_'n_1@127.0.0.1':backfill_start_timestamp: 1371675343
 eq_tapq:replication_building_485_'n_1@127.0.0.1':flags: 85 (ack,backfill,vblist,checkpoints)
 eq_tapq:replication_building_485_'n_1@127.0.0.1':pending_backfill: true
 eq_tapq:replication_building_485_'n_1@127.0.0.1':pending_disk_backfill: true
 eq_tapq:replication_building_485_'n_1@127.0.0.1':queue_backfillremaining: 202</samp></pre>
<p class="p">When
   all have completed, you should see the Total Item count ( <samp class="ph codeph">curr_items_tot</samp> ) be
   equal to the number of active items multiplied by replica count. The output you see for a TAP
   stream after backfill completes is as
   follows:</p>
<pre class="pre codeblock"><samp class="ph codeph">eq_tapq:replication_building_485_'n_1@127.0.0.1':backfill_completed: true
 eq_tapq:replication_building_485_'n_1@127.0.0.1':backfill_start_timestamp: 1371675343
 eq_tapq:replication_building_485_'n_1@127.0.0.1':flags: 85 (ack,backfill,vblist,checkpoints)
 eq_tapq:replication_building_485_'n_1@127.0.0.1':pending_backfill: false
 eq_tapq:replication_building_485_'n_1@127.0.0.1':pending_disk_backfill: false
 eq_tapq:replication_building_485_'n_1@127.0.0.1':queue_backfillremaining: 0</samp></pre>
<p class="p">If
   you are continuously adding data to the system, these values may not correspond exactly at a
   given instant in time. However you should be able to determine whether there is a significant
   difference between the two figures.</p>
</div>

   
    <div class="section"><h2 class="title sectiontitle">Draining</h2> <p class="p">After the backfill process is complete, all nodes that had replicas materialized on them
      have to persist these items to disk. It is important to continue monitoring the disk
      write queue and memory usage until the rebalancing operation has been completed, to ensure that
      the cluster is able to keep up with the write load and required disk I/O.</p>
</div>

 
  </div>

  
  <nav class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../Monitoring/monitor-intro.html" title="プロセス、ポート、キューなど、Couchbase Serverをモニタリングするためのさまざまな方法があります。">モニタリング</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../Monitoring/monitor-warmup.html">Monitoring startup (warmup)</a></div>
</div>

<div class="linklist linklist">
<div><a class="link" href="../REST/rest-cluster-rebalance.html" title="Nodes are rebalanced with the POST /controller/rebalance HTTP method and URI.">Rebalancing nodes</a></div></div>
</nav>

</body>
</html>