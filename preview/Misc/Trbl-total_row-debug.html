<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-us">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8"><meta name="copyright" content="(C) Copyright 2015">
<meta name="DC.rights.owner" content="(C) Copyright 2015">
<meta name="DC.Type" content="topic">
<meta name="description" content="There are cases where the total_rows value is higher than expected."><meta name="DC.Relation" scheme="URI" content="../Misc/Trbl-intro.html">
<meta name="DC.Relation" scheme="URI" content="../Misc/Trbl-timeoutErrors.html">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="topic2080">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../commonltr.css">
<title>total_rows values are too high</title>
</head>
<body id="topic2080">


  <h1 class="title topictitle1">total_rows values are too high</h1>

  
  <div class="body"><p class="shortdesc">There are cases where the <samp class="ph codeph">total_rows</samp> value is higher than expected.</p>

    <p class="p">In some scenarios, it’s expected to see queries returning a <samp class="ph codeph">total_rows</samp> field
      with a value higher than the maximum rows they can return (map view queries without an
      explicit <samp class="ph codeph">limit</samp>, <samp class="ph codeph">skip</samp>, <samp class="ph codeph">startkey</samp> or
        <samp class="ph codeph">endkey</samp> ).</p>

    <p class="p">The expected scenarios are during rebalance, and immediately after a failover for a finite
      period of time.</p>

    <p class="p">This happens because in these scenarios some vbuckets are marked for cleanup in the indexes,
      temporarily marked as passive, or data is being transferred from the replica index to the main
      index (after a failover). While the rows originated from those vbuckets are never returned to
      queries, they contribute to the reduction value of every view btree, and this value is what is
      used for the <samp class="ph codeph">total_rows</samp> field in map view query responses (it’s simply a
      counter with total number of Key-Value pairs per view).</p>

    <p class="p">Ensuring that <samp class="ph codeph">total_rows</samp> always reflected the number of rows originated from
      documents in active vbuckets would be very expensive, severely impacting performance. For
      example, we would need to maintain a different value in the btree reductions which would map
      vbucket IDs to row counts:</p>

    <pre class="pre codeblock"><samp class="ph codeph">{"0":56, "1": 2452435, ..., "1023": 432236}
</samp></pre>

    <p class="p">This would significantly reduce the btrees branching factor, making them much more deep,
      using more disk space and taking more time to compute reductions on
      inserts/updates/deletes.</p>

    <p class="p">To know if there are vbuckets under cleanup, vbuckets in passive state or vbuckets being
      transferred from the replica index to main index (on failover), one can query the following
      URL:</p>

    <pre class="pre codeblock"><samp class="ph codeph">&gt; curl -s 'http://localhost:9500/_set_view/default/_design/dev_test2/_info' | json_xs
{
   "passive_partitions" : [1, 2, 3],
   "cleanup_partitions" : [],
   "replicas_on_transfer" : [1, 2, 3],
   (....)
}
</samp></pre>

    <p class="p">Note that the example above intentionally hides all non-relevant fields. If any of the fields
      above is a non-empty list, than <samp class="ph codeph">total_rows</samp> for a view may be higher than
      expected, that is, we’re under one of those expected scenarios mentioned above. In steady
      state all of the above fields are empty lists.</p>

  </div>

<nav class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../Misc/Trbl-intro.html" title="トラブルシューティングの一般的なヒント、一般的なエラー、ログ情報、およびその他の問題について説明します。">トラブルシューティング</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../Misc/Trbl-timeoutErrors.html" title="Timeout errors when querying a view with stale=false.">Timeout errors</a></div>
</div>
</nav>
</body>
</html>