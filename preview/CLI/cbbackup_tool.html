<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="ja">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8"><meta name="copyright" content="(C) Copyright 2015">
<meta name="DC.rights.owner" content="(C) Copyright 2015">
<meta name="DC.Type" content="reference">
<meta name="description" content="cbbackupツールは、稼働中の全クラスタ・全バケット・単一ノード・正常稼働中ノード上の単一バケット のコピーを作成します。"><meta name="DC.Relation" scheme="URI" content="../cli-intro.html">
<meta name="DC.Relation" scheme="URI" content="../CLI/cbanalyze-core_tool.html">
<meta name="DC.Relation" scheme="URI" content="../CLI/cbcollect_info_tool.html">
<meta name="DC.Relation" scheme="URI" content="../CLI/cbbackup-ddocs.html">
<meta name="DC.Relation" scheme="URI" content="../CLI/cli-increment-backup.html">
<meta name="DC.Relation" scheme="URI" content="../Install/hostnames.html">
<meta name="DC.Relation" scheme="URI" content="cbcli-intro.html">
<meta name="DC.Relation" scheme="URI" content="cbrestore_tool.html">
<meta name="DC.Relation" scheme="URI" content="cbtransfer_tool.html">
<meta name="DC.Relation" scheme="URI" content="https://github.com/couchbase/couchbase-cli">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="cbbackup-tool">
<meta name="DC.Language" content="ja">
<link rel="stylesheet" type="text/css" href="../commonltr.css">
<title>cbbackupツール</title>
</head>
<body id="cbbackup-tool">


   <h1 class="title topictitle1">cbbackupツール</h1>

   
   
   <div class="body refbody"><p class="shortdesc"><samp class="ph codeph">cbbackup</samp>ツールは、稼働中の全クラスタ・全バケット・単一ノード・正常稼働中ノード上の単一バケット
   のコピーを作成します。</p>

      <div class="section"><h2 class="title sectiontitle">定義</h2>
      <p class="p">バックアッププロセスは、ディスク上にデータのコピーを書き込みます。
         <samp class="ph codeph">cbbackup</samp>を使用してバックアップを作成するために、ノードもしくはクラスタは、正常な状態で稼働している必要があります。</p>


      <p class="p"><samp class="ph codeph">cbbackup</samp>ツール, <samp class="ph codeph">cbrestore</samp>ツール, <samp class="ph codeph">cbtransfer</samp>ツール
         は、クラスタに所属しないサーバーと外部IPアドレスでは通信しません。
         バックアップ、リストア、転送のオペレーションは、Couchbaseクラスタ内のノード内でデータを扱います。
         クラスタから取得したノードリスト内のノードのみと通信します。
         そのため、CouchbaseServerがデフォルトIPアドレスでインストールされていれば、外部からの接続用ホスト名ではアクセス出来ません。</p>

         
         <p class="p">このツールを使うときは、以下のオプションを使うことが出来ます:</p>

         <ul class="ul">
            <li class="li">クラスタ内の全てのバケットのバックアップを作成</li>

            <li class="li">クラスタ内で、名前を指定したバケットのバックアップを作成</li>

            <li class="li">クラスタ内のあるノードの全バケットのバックアップを作成</li>

            <li class="li">特定ノードの、名前を指定したバケットのバックアップを作成</li>

         </ul>

         
         <div class="note tip"><span class="tiptitle">ヒント:</span> <samp class="ph codeph">cbbackup</samp>の結果は、サーバーのローカルファイルシステムに出力することを推奨します。
            特に、専用パーティションにバックアップするのが良いでしょう。
            専用パーティションにすることで、バックアップがCouchbaseのデータストアやOS領域を圧迫することを防げます。
         </div>

         
         
         <div class="cautiontitle">注意:</div><div class="note caution"><samp class="ph codeph">cbbackup</samp>の結果を、共有リモートファイルシステム(NFS)に出力することは避けましょう。 
            <samp class="ph codeph">cbbackup</samp>の出力ファイルは、リモートファイルシステムへの書き込みに問題のあるsqlite formatとsqlite-formatted fileで出来ているからです。
         </div>

         
      <p class="p">このツールは以下に存在します:</p>


      
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all">
            
            
            <thead class="thead" align="left">
               <tr class="row">
                  <th class="entry" valign="top" width="50%" id="d34280e85">OS</th>

                  <th class="entry" valign="top" width="50%" id="d34280e88">存在場所</th>

               </tr>

            </thead>

            <tbody class="tbody">
               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e85 ">Linux</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e88 "><samp class="ph codeph">/opt/couchbase/bin/cbbackup</samp></td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e85 ">Windows</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e88 "><samp class="ph codeph">C:\Program&nbsp;Files\Couchbase\Server\bin\cbbackup</samp></td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e85 ">Mac OS X</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e88 "><samp class="ph codeph">/Applications/Couchbase&nbsp;Server.app/Contents/Resources/couchbase-core/bin/cbbackup</samp></td>

               </tr>

            </tbody>

         </table>
</div>

      </div>

      
      <div class="section"><h2 class="title sectiontitle">CLIコマンドとパラメータ </h2>

      <p class="p"><samp class="ph codeph">cbbackup</samp>コマンドのフォーマット:</p>

      <pre class="pre codeblock">cbbackup [options] [source] [backup-dir]
</pre>

      <p class="p">詳細:</p>

      <ul class="ul">
         <li class="li">[options]<p class="p"><samp class="ph codeph">cbtransfer</samp>ツールと同じオプションが使えます</p>
</li>

         <li class="li">[source]<p class="p">バックアップするソース元を指定します。
                        バックアップ元がシングルノードかクラスタであればノードのURLを、バックアップ元が単一バケットの場合はディレクトリのURLを指定することが出来ます。</p>
</li>

         <li class="li">[backup-dir]<p class="p">バックアップファイルの保存先ディレクトリを指定します。
                            既に存在する空のディレクトリを指定するか、指定したディレクトリを新規に作ることが出来ます。
                            新規に作る場合は、必ず親ディレクトリは既に存在する必要があります。</p>
</li>

      </ul>


      
      <p class="p">コマンドのオプション:</p>

      
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><caption><span class="tablecap">表 1. cbrestoreのオプション</span></caption>
            
            
            <thead class="thead" align="left">
               <tr class="row">
                  <th class="entry" valign="top" width="50%" id="d34280e183">パラメータ</th>

                  <th class="entry" valign="top" width="50%" id="d34280e186">定義</th>

               </tr>

            </thead>

            <tbody class="tbody">
               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e183 ">-h, –help</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e186 ">コマンドラインのヘルプ</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e183 ">-b ソースバケット, --bucket-source=ソースバケット</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e186 ">ソースクラスタから転送する、名前指定の1つのバケット。
                         バックアップディレクトリに1つしかバケットがない場合、自動的にそのバケットが選択されます。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e183 ">--single-node</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e186 ">クラスタ全体の全てのノードを使わず、1つのサーバーのみを使います。
                         このノードは、ソースURLを指定して定義します。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e183 ">-m モード, --mode=モード</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e186 ">&nbsp;</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e183 ">-i ID, –id=ID</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e186 ">vbucket IDにマッチしたアイテムのみを転送します。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e183 ">-k KEY, –key=KEY</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e186 ">正規表現でマッチしたキーに該当するアイテムのみを転送します。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e183 ">-n, –dry-run</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e186 ">実際の転送は実行しません。パラメータ・ファイル・コネクティビティ・設定のチェックだけを実施します</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e183 ">-u USERNAME, –username=USERNAME</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e186 ">ソースクラスタもしくはノードのREST usernameを指定します。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e183 ">-p PASSWORD, –password=PASSWORD</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e186 ">ソースクラスタもしくはノードのREST passwordを指定します。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e183 ">-t スレッド数, –threads=スレッド数</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e186 ">転送のためのワーカースレッド数を指定します。 </td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e183 ">-v, –verbose</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e186 ">ログレベルを上げます。vの数を増やすことでログレベルが上がります。最大は[-vvv]です。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e183 ">-x EXTRA, –extra=EXTRA</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e186 ">一般的ではない拡張設定パラメータを指定します。カンマ区切りで、key=val(key-val)*形式で指定します。</td>

               </tr>

               
            </tbody>

         </table>
</div>

      <p class="p"><samp class="ph codeph">cbbackup -x</samp>のコマンドオプションパラメータは以下のとおりです。</p>

      
      
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><caption><span class="tablecap">表 2. cbbackup -x options</span></caption>
            
            
            <thead class="thead" align="left">
               <tr class="row">
                  <th class="entry" valign="top" width="50%" id="d34280e325">-x options</th>

                  <th class="entry" valign="top" width="50%" id="d34280e328">定義</th>

               </tr>

               
            </thead>

            <tbody class="tbody">
               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">backoff_cap=10</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e328 ">リバランス中の最大バックオフ時間です。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">batch_max_bytes=400000</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e328 ">指定サイズ(bytes)に分割して転送します。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">batch_max_size=1000</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e328 ">一度の転送では、ここて定義したドキュメント数を最大とします。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">cbb_max_mb=100000</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e328 ">指定したサイズ（MB）を超えると、宛先クラスタ上のファイルを分割します。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">conflict_resolve=1</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e328 ">デフォルトでは、コンフリクトの解決は無効となっています。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">data_only=0</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e328 ">1にすれば、ファイルもしくはクラスタからデータのみを転送します。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">design_doc_only=0</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e328 ">1にすれば、ファイルもしくはクラスタから、デザインドキュメントのみを転送します。デフォルトは0です。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">max_retry=10</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e328 ">転送に失敗した場合、指定した回数までリトライします。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">mcd_compatible=1</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e328 ">0にすれば、標準出力に出力します。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">nmv_retry=1</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e328 ">1にすれば、NOT_MY_VBUCKET messageの後に転送をリトライします。デフォルトは1です。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">recv_min_bytes=4096</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e328 ">各TCP/IPで転送する場合の容量です。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">rehash=0</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e328 ">1にすると、各アイテムのパーティションIDを作り直します。
                     クラスタ間でデータを転送するとき、パーティションの数が異なる場合に必要になります。
                     例えば、MAC OS Xサーバーから、それ以外のサーバーに対して転送するときなどです。
                  </td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">report=5</td>

				  <td class="entry" valign="top" width="50%" headers="d34280e328 ">コンソールの進捗バーを更新する間隔となるバッチ転送数を指定します。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">report_full=2000</td>

				  <td class="entry" valign="top" width="50%" headers="d34280e328 ">コンソールの進捗状況を更新する間隔となるバッチ転送数を指定します。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">seqno=0</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e328 ">デフォルトでは、seqnoは最初から開始します。</td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">try_xwm=1</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e328 ">1にすると、ドキュメントと一緒にメタデータも転送します。デフォルトは1です。
                         0は、version 1.8.xから1.8.xに転送する場合のみ使えます。
                  </td>

               </tr>

               <tr class="row">
                  <td class="entry" valign="top" width="50%" headers="d34280e325 ">uncompress=0</td>

                  <td class="entry" valign="top" width="50%" headers="d34280e328 ">1にすると、圧縮せずにデータを保存します。</td>

               </tr>

            </tbody>

         </table>
</div>

      </div>

      
      <div class="section"><h2 class="title sectiontitle">シンタックス</h2>
         <p class="p">以下が基本的なシンタックスです:</p>

         <pre class="pre codeblock">cbrestore [options] [backup-dir] [destination]</pre>

         
         
         <p class="p">以下に、フルバックアップ実行後、2度増分バックアップする場合の例を示します。</p>

         
         <pre class="pre codeblock">
cbbackup http://HOST:8091 /backup-42
cbbackup http://HOST:8091 /backup-42
cbbackup http://HOST:8091 /backup-42
         </pre>

         
         <p class="p">以下に、フルバックアップ実行後、2度差分バックアップを実行し、シングルノードに対してaccumulativeバックアップする例を示します。</p>

         <pre class="pre codeblock">
cbbackup couchbase://HOST:8091 /backup-43 [-m full] --single-node
cbbackup couchbase://HOST:8091 /backup-43 [-m diff] --single-node
cbbackup couchbase://HOST:8091 /backup-43 [-m diff] --single-node
cbbackup couchbase://HOST:8091 /backup-43 -m accu --single-node
         </pre>

            
         <div class="note note"><span class="notetitle">注:</span> バックアップ・リストアした後、忘れずにインデックスをリビルドしてください。</div>


      </div>

      
      
      <div class="section"><h2 class="title sectiontitle">例: クラスタのバックアップ</h2>
      <p class="p">クラスタ全体をバックアップできます。
      このバックアップには、全てのノードに保存された全てのバケット・データ、全てのデザインドキュメントが含まれます。
      クラスタ全体と全バケットのバックアップは以下のとおりです。</p>

      <pre class="pre codeblock">cbbackup http://HOST:8091 ~/backups \
          -u Administrator -p password
</pre>

      <p class="p"><samp class="ph codeph">~/backups</samp>は、データを保存するディレクトリを指定します。
      この操作がされたとき、<samp class="ph codeph">N1</samp>, <samp class="ph codeph">N2</samp>というノードがあり、<samp class="ph codeph">my_name</samp>, <samp class="ph codeph">sasl</samp>というバケットがあった場合、cbbackupは、以下のとおりのディレクトリとファイルを作成します:</p>

      <pre class="pre codeblock">~/backups
        bucket-my_name
            N1
            N2
        bucket-sasl
            N1
            N2
</pre>

      <p class="p">
      <samp class="ph codeph">bucket-my_name</samp>と<samp class="ph codeph">bucket-sasl</samp> は、データファイルを含むディレクトリであり、<samp class="ph codeph">N1</samp>,<samp class="ph codeph">N2</samp>はクラスタ内の各ノードの2つのデータセットです。
      </p>


         
         </div>

      
      <div class="section"><h2 class="title sectiontitle">例: 1つのバケットのバックアップ</h2>
         <p class="p">クラスタ内の1つのバケットのバックアップ方法は以下です:</p>

      
      <pre class="pre codeblock">cbbackup http://HOST:8091 /backups/backup-20120501 \
  -u Administrator -p password \
  -b default
</pre>

      <p class="p">このケースでは、クラスタ内のdefaultバケットが指定され、defaultバケットのデータがバックアップされます。
      </p>

         
      </div>

      
      
      <div class="section"><h2 class="title sectiontitle">例: 複数バケットのバックアップ</h2>
         <p class="p">シングルノードの複数のバケットからデータをバックアップする場合:</p>

      <pre class="pre codeblock">&gt; cbbackup http://HOST:8091 /backups/ \
  -u Administrator -p password \
  --single-node
</pre>

      <p class="p">シングルノードの1つのバケットからデータをコピーする場合:</p>

      <pre class="pre codeblock">cbbackup http://HOST:8091 /backups \
  -u Administrator -p password \
  --single-node \
  -b bucket_name
</pre>

      </div>

      
      <div class="section"><h2 class="title sectiontitle">例: キーのバックアップ</h2>
      <p class="p"><samp class="ph codeph">- k</samp>オプションを使うことで、バックアップするキーを特定することが出来ます。例えば、
       バケット内で‘object’というプレフィックスを持つキーを全てバックアップする場合:</p>

      
      <pre class="pre codeblock">&gt; cbbackup http://HOST:8091 /backups/backup-20120501 \
  -u Administrator -p password \
  -b bucket_name \
  -k '^object.*'
</pre>

      </div>


      
   </div>

   <nav class="related-links">
<ol class="olchildlinks">
<li class="link olchildlink"><a href="../CLI/cbbackup-ddocs.html">Backing up design documents</a><br>
Design documents are backed up with the <samp class="ph codeph">design_doc_only=1</samp> option.</li>
<li class="link olchildlink"><a href="../CLI/cli-increment-backup.html">Backing up incrementally</a><br>
Incremental backups are run by using the <samp class="ph codeph">cbbackup</samp> 			command-line tool.</li>
</ol>

<div class="familylinks">
<div class="parentlink"><strong>親トピック:</strong> <a class="link" href="../cli-intro.html" title="Couchbase Server command-line interface (CLI) tools are provided to manage and monitor clusters, servers, vBuckets, XDCR, and so on.">CLI reference</a></div>
<div class="previouslink"><strong>前のトピック:</strong> <a class="link" href="../CLI/cbanalyze-core_tool.html" title="The cbanalyze-core tool is used to parse and analyze core dump data.">cbanalyze-core tool</a></div>
<div class="nextlink"><strong>次のトピック:</strong> <a class="link" href="../CLI/cbcollect_info_tool.html" title="The cbcollect_info tool provides detailed statistics for a specific node.">cbcollect_info tool</a></div>
</div>

<div class="linklist linklist">
<div><a class="link" href="../Install/hostnames.html" title="Each Couchbase Server's instance can have its own hostname.">Using hostnames</a></div>
<div><a class="link" href="cbcli-intro.html" title="The couchbase-cli tool is used to perform operations on an entire cluster.">couchbase-cli tool</a></div>
<div><a class="link" href="cbrestore_tool.html" title="The cbrestore tool restores data from a file to an entire cluster or to a single bucket in the cluster.">cbrestore tool</a></div>
<div><a class="link" href="cbtransfer_tool.html" title="The cbtransfer tool is used to transfer data between clusters and to/from files.">cbtransfer tool</a></div>
<div><a class="link" href="https://github.com/couchbase/couchbase-cli" target="_blank">Couchbase command-line tools GitHub repository</a></div></div>
</nav>

</body>
</html>