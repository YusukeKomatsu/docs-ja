<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="topic_wzx_szg_14" xml:lang="ja">
	<title>データベース変更プロトコル(DCP)</title>
	<shortdesc>データベース変更プロトコル(Database Change Protocol, DCP)はバケットのデータ更新をストリームするためのプロトコロルです。</shortdesc>

	<body>
		<p>The Database Change Protocol (DCP)はView更新のレイテンシを大幅に縮めることができるストリーミングプロトコルです。 
DCPにより、メモリ上のドキュメントに対する変更はディスクに書き込まれる前に即座にストリームされ、インデクシングされます。
このため、より高速にViewの一貫性を提供し、最新のデータを返却することができます。
DCPはまた、クロスデータセンタレプリケーション(XDCR)のレイテンシも小さくします。
データは、ソースクラスタのディスクに書き込まれる前に、ソースクラスタのメモリから宛先クラスタのメモリへとレプリケートされます。
</p>

		<p>DCPを利用するには、以下のコンセプト(アルファベット順)を理解する必要があります。</p>

		<dl>
			<dlentry>
				<dt>アプリケーションクライアント</dt>
				<dd>サーバクラスタに参照、書込み、更新、削除、クエリのリクエストを送信する通常のクライアントです。一般的にはインタラクティブなWebアプリケーションです。</dd>
			</dlentry>

			<dlentry>
				<dt>DCPクライアント</dt>
				<dd>
ひとつ以上のCouchbase Serverノードからデータをストリーミング受信する特別なクライアントです。
クラスタ内レプリケーション(マスタサーバがダウンした際にバックアップとなる)、インデクシング(クラスタ全体のデータを集約してクエリに応答するため)、
XDCR(あるクラスタから別のクラスタへとデータをレプリケートするため、通常は別のデータセンタに設置されたクラスタ)、
差分バックアップ、そしてCouchbaseのデータを準リアルタイムもしくはスケジュール起動のバッチモードで、
インデクシング、モニタリング、あるいは分析を行うサードパーティのコンポーネントが該当します。
</dd>
			</dlentry>

			<dlentry>
				<dt>フェイルオーバログ</dt>
				<dd>
あるvBucketにおける、以前に接続したことのあるvBucketのバージョンのリストです。
もしクライアントがサーバに接続し、サーバ上の現在のvBucketのバージョンが、以前に接続したものと異なっている場合、
フェイルオーバログを利用してロールバックポイントを探します。
</dd>
			</dlentry>

			<dlentry>
				<dt>ヒストリブランチ</dt>
				<dd>
あるノードがフェイルオーバや、不正なシャットダウンおよび再起動により、特定のvBucketのマスタとなったとき、
もしそのノードが、そのvBucketで発生しているイベントを受信しているすべてのプロセスにおいて、
最新の状態となっていないまま データ更新を引き継いだ場合、
他のプロセスがすでにこのvBucketで受信済みのシーケンス番号を使い回す可能性があります。
これは、ヒストリブランチとなり、新しいマスタは、分散システム内のDCPクライアントが
新しいマスタよりも先に進んでいて、このストリームにおいてマスタ切り替えが発生した時点にロールバックが必要だと
認識できるように、vBucketを新しいvBucketのバージョンにアサインしなくてはなりません。

適切に制御されて旧マスタから新マスタへ引き継がれた場合、
シーケンスのヒストリにブランチはできません。
引き継がれるvBucketに新しいバージョンを割り当てる必要はないからです。
クラスタ伸縮時のリバランス(ノードの追加や削除)、アップグレード時のスワップリバランス(新しいCouchbase Serverバージョンのノードをクラスタへ追加し、古いバージョンのノードを削除)した場合は、正しく引き継ぎを制御することができます。
</dd>
			</dlentry>

			<dlentry>
				<dt>データの変化(Mutation)</dt>
				<dd>
データの変化とはキーを削除したり、キーと対になるバリューを変更するイベントのことです。
データの生成、更新、削除、期限切れなどの更新処理が実行されると発生します。
					</dd>
			</dlentry>

			<dlentry>
				<dt>ロールバックポイント</dt>
				<dd>
サーバはフェイルオーバログを利用して、
クライアントがデータの変化を最後に受信した時から現在までの間で利用可能な、直近のヒストリブランチを探します。
そのヒストリブランチのシーケンス番号が、クライアントに送信されるロールバックポイントとなります。
</dd>
			</dlentry>

			<dlentry>
				<dt>シーケンス番号</dt>
				<dd>
あるvBucketで発生した各データの変化には番号が割り当てられます。
これはイベントに番号を付与するたびに厳密に増加するものです(番号をスキップしても問題ありませんが、増加する必要があります)。
同一のvBucketにおけるデータの変化イベントのソートに利用します。
これはクラスタ全体でのイベント順序を保証するものではありませんが、
特定のvBucketで発生するイベントを監視するプロセスで、切断したところからの再開を可能にします。
</dd>
			</dlentry>

			<dlentry>
				<dt>サーバ</dt>
				<dd>
クラスタのネットワークストレージコンポーネントとして動作するマスタおよびレプリカノードです。
ひとつのパーティションにつき、クラスタ内で一台のノードだけがマスタになることができます。
マスタがダウンもしくは利用不可となると、クラスタは新しいマスタとなるレプリカノードを選出します。
</dd>
			</dlentry>

			<dlentry>
				<dt>スナップショット</dt>
				<dd>
クライアントに一貫したデータ像を送信するため、
クライアントの現在のリクエストを満たす最適な場所を考慮し、
サーバはディスク書込みキュー状態もしくはストレージ状態のスナップショットを取得します。

このスナップショットは、取得時に含まれるデータの変化の完全な状態を表します。
スナップショットを利用して、サーバはスナップショット取得時点で存在したアイテムのみを送信することができます。

スナップショットの作成にはすべてをロックして別の構造にコピーする必要はありません。
原稿のCouchbaseストレージサブシステムでは、
本質的に、スナップショットの取得にはコストがかかりません。
唯一のコストは不要なデータとスペースを除去するためのコンパクションでファイルがコピーされる際に、すべてのスナップショットホルダがコンパクション前のファイルをリリースするのを待つ必要があることです。

もしスナップショットホルダがスナップショットの取得に時間がかかり過ぎているとシステムが判断した場合、スナップショットホルダを強制的に停止することができます。
このとき、切断されたDCPクライアントは再接続し、新規のスナップショットが取得され、切断した箇所からリスタートすることができます。
</dd>
			</dlentry>

			<dlentry>
				<dt>vBucket</dt>
				<dd>
Couchbaseはキー空間を固定数のvBucketに分割します、通常は1024です。
キーは決まった方法でvBucketに割り当てられ、vBucketはクラスタ内で不可がバランスされるようにノードに割り当てられます。
</dd>
			</dlentry>

			<dlentry>
				<dt>vBucketストリーム</dt>
				<dd>
特定のvBucketにおけるデータ変化の受信に関連するメッセージのグループです。
データの変化、削除、期限切れのメッセージ、およびスナップショットマーカのメッセージを含みます。
転送レイヤは複数の異なるvBucketの情報ストリームを複合化したり、分離する手順を提供します。
スナップショットマーカ間のすべてのメッセージは単一のスナップショットとして扱われます。
スナップショットは、各キーについて、取得間隔内で最新の変更しか保持しません。
ドキュメントの最新バージョンを得るには、いくつかの完全なスナップショットが必要になることがあります。
</dd>
			</dlentry>

			<dlentry>
				<dt>vBucketのバージョン</dt>
				<dd>
vBucketに関連する、普遍的に一意となる識別子(UUID)とシーケンス番号のペアです。
ヒストリブランチが存在する可能性がある場合に、新しいマスタノードによって、新しいバージョンがvBucketに割り当てられます。
UUIDはランダムに生成された数値で、シーケンス番号はそのバージョンが作成されたときにvBucketが最後に処理したものです。
</dd>
			</dlentry>

		</dl>



	</body>

</topic>
