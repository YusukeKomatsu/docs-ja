<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-us">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8"><meta name="copyright" content="(C) Copyright 2015">
<meta name="DC.rights.owner" content="(C) Copyright 2015">
<meta name="DC.Type" content="reference">
<meta name="description" content="Nodes are rebalanced with the POST /controller/rebalance HTTP method and URI."><meta name="DC.Relation" scheme="URI" content="../REST/rest-cluster-intro.html">
<meta name="DC.Relation" scheme="URI" content="../REST/rest-cluster-removenode.html">
<meta name="DC.Relation" scheme="URI" content="../REST/rest-get-internal-setting.html">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="rest-cluster-rebalance-nodes">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../commonltr.css">
<title>Rebalancing nodes</title>
</head>
<body id="rest-cluster-rebalance-nodes">


  <h1 class="title topictitle1">Rebalancing nodes</h1>

  <p class="shortdesc">Nodes are rebalanced with the <samp class="ph codeph">POST /controller/rebalance</samp> HTTP method and URI.</p>

  
  <nav class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../REST/rest-cluster-intro.html" title="The Cluster REST API manages cluster operations.">Cluster API</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../REST/rest-cluster-removenode.html" title="Nodes are removed from clusters with the POST /controller/ejectNode HTTP method and URI.">Removing nodes from clusters</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../REST/rest-get-internal-setting.html" title="Internal settings change cluster behavior. Internal settings are for Couchbase use only.">Viewing internal settings</a></div>
</div>
</nav><div class="topic reference nested1" id="rest-cluster-rebalance-description">
    <h2 class="title topictitle2">Description</h2>

  <div class="body refbody">
    <div class="section">
      <p class="p">To start a rebalance process, provide the <samp class="ph codeph">ejectedNodes</samp> and
          <samp class="ph codeph">knownNodes</samp> parameters. These parameters contain the list of nodes that
        have been marked to be ejected and the list of nodes that are known within the cluster. </p>

      
      <p class="p">Retrieve information about ejected and known
        nodes by getting the current node configuration. This ensures that the client making the
        REST API request is aware of the current cluster configuration. Nodes should have been
        previously added or marked for removal as appropriate.</p>

      
    </div>


    <div class="section"><h3 class="title sectiontitle">HTTP method and URI</h3>
      
      <p class="p">The information must be
        supplied via the <samp class="ph codeph">ejectedNodes</samp> and <samp class="ph codeph">knownNodes</samp> parameters as
        a <samp class="ph codeph">POST</samp> operation to the <samp class="ph codeph">/controller/rebalance</samp> endpoint.</p>

      
      <pre class="pre codeblock">
POST /controller/rebalance
      </pre>

    </div>

    
    <div class="section"><h3 class="title sectiontitle">Syntax</h3>
      <pre class="pre codeblock">
curl -v -X -u [admin]:[password] POST
  http://[localhost]:8091/controller/rebalance
  -d ejectedNodes
  -d knownNodes
        
      </pre>

    </div>

    
    <div class="section"><h3 class="title sectiontitle">Example</h3>
      <p class="p">Curl request example:</p>

      <pre class="pre codeblock">curl -v -X -u admin:password POST 'http://192.168.0.77:8091/controller/rebalance' \
  -d 'ejectedNodes=&amp;knownNodes=ns_1%40192.168.0.77%2Cns_1%40192.168.0.56'
</pre>

      
      <p class="p">Raw HTTP request example:</p>

      <pre class="pre codeblock">POST /controller/rebalance HTTP/1.1
Authorization: Basic QWRtaW5pc3RyYXRvcjpUYW1zaW4=
User-Agent: curl/7.24.0 (x86_64-apple-darwin12.0) libcurl/7.24.0 OpenSSL/0.9.8r zlib/1.2.5
Host: 192.168.0.77:8091
Accept: */*
Content-Length: 63
Content-Type: application/x-www-form-urlencoded
</pre>

    </div>

    
    <div class="section"><h3 class="title sectiontitle">Response codes</h3>
    <p class="p">The
        response is 200 (OK) if the operation was successfully submitted.</p>
<p class="p">If the wrong node
        information has been submitted, JSON with the mismatch error is
      returned:</p>

      <pre class="pre codeblock">{"mismatch":1}</pre>

    </div>

  </div>

  </div>

  
  <div class="topic reference nested1" id="rest-cluster-rebalance-getprogress">
    <h2 class="title topictitle2">Getting rebalance progress</h2>

    <div class="body refbody">


    <div class="section"><h3 class="title sectiontitle">HTTP method and URI</h3>
      
      <p class="p">There are two endpoints for rebalance
        progress. One is a general request which outputs high-level percentage completion at
          <samp class="ph codeph">/pools/default/rebalanceProgress</samp>. The second possible endpoint is one
        corresponds to the detailed rebalance report available in the web console.</p>

      
      <pre class="pre codeblock">
GET /pools/default/rebalanceProgress
      </pre>

    </div>

      
      <div class="section"><h3 class="title sectiontitle">Syntax</h3>
        <pre class="pre codeblock">curl -u [admin]:[password] 
'[localhost]:8091/pools/default/rebalanceProgress'
        </pre>

      </div>

        
      <div class="section"><h3 class="title sectiontitle">Example</h3> 
      
      <p class="p">Curl request example that returns a JSON structure containing the current progress information:</p>

        
        <pre class="pre codeblock">curl -u admin:password 
'192.168.0.77:8091/pools/default/rebalanceProgress'
        </pre>

        
        <p class="p">Raw HTTP request example:</p>

        
        <pre class="pre codeblock">GET /pools/default/rebalanceProgress HTTP/1.1
Authorization: Basic QWRtaW5pc3RyYXRvcjpUYW1zaW4=
User-Agent: curl/7.24.0 (x86_64-apple-darwin12.0) libcurl/7.24.0 OpenSSL/0.9.8r zlib/1.2.5
Host: 192.168.0.77:8091
Accept: */*
</pre>

      </div>

      
      <div class="section"><h3 class="title sectiontitle">Response</h3>
        
        <p class="p">The
        response data packet contains a JSON structure showing the rebalance progress for each node.
        The progress figure is provided as a percentage (shown as a floating point value between 0
        and
        1).</p>

        
        <pre class="pre codeblock">{
    "status":"running",
    "ns_1@192.168.0.56":{"progress":0.2734375},
    "ns_1@192.168.0.77":{"progress":0.09114583333333337}
}
</pre>

      </div>

      
      <div class="section"><h3 class="title sectiontitle">Example: detailed</h3>
        
        <p class="p">Curl request example with more details about the rebalance:</p>

        
        <pre class="pre codeblock">curl -u admin:password
  'http://192.168.0.77:8091/pools/default/tasks'
        </pre>

        
        <p class="p">Raw HTTP request example:</p>

        
        <pre class="pre codeblock">GET /pools/default/rebalanceProgress HTTP/1.1
Authorization: Basic QWRtaW5pc3RyYXRvcjpUYW1zaW4=
User-Agent: curl/7.24.0 (x86_64-apple-darwin12.0) libcurl/7.24.0 OpenSSL/0.9.8r zlib/1.2.5
Host: 192.168.0.77:8091
Accept: */*
        </pre>

      </div>

      
      <div class="section"><h3 class="title sectiontitle">Response: detailed</h3>
        <p class="p">The response data packet contains a JSON structure showing detailed
        progress:</p>

        
        <pre class="pre codeblock">
{
  type: "rebalance",
  recommendedRefreshPeriod: 0.25,
  status: "running",
  progress: 9.049479166666668,
  perNode: {
    ns_1@10.3.3.61: {
      progress: 13.4765625
    },
    ns_1@10.3.2.55: {
      progress: 4.6223958333333375
    }
  },
  detailedProgress: {
    bucket: "default",
    bucketNumber: 1,
    bucketsCount: 1,
    perNode: {
      ns_1@10.3.3.61: {
        ingoing: {
          docsTotal: 0,
          docsTransferred: 0,
          activeVBucketsLeft: 0,
          replicaVBucketsLeft: 0
        },
        outgoing: {
          docsTotal: 512,
          docsTransferred: 69,
          activeVBucketsLeft: 443,
          replicaVBucketsLeft: 511
        }
      },
      ns_1@10.3.2.55: {
        ingoing: {
          docsTotal: 512,
          docsTransferred: 69,
          activeVBucketsLeft: 443,
          replicaVBucketsLeft: 0
        },
        outgoing: {
          docsTotal: 0,
          docsTransferred: 0,
          activeVBucketsLeft: 0,
          replicaVBucketsLeft: 443
        }
      }
    }
  }
}
</pre>

        
        <p class="p">This reponse shows percentage complete for each individual node undergoing rebalance. For each specific
        node, it provides the current number of docs transferred and other items. For details and
        definitions of these items.</p>
<p class="p">If rebalance fails, the following response error occurs:</p>

        
        <pre class="pre codeblock">[
  {
    "type": "rebalance",
    "status": "notRunning",
    "errorMessage": "Rebalance failed. See logs for detailed reason. You can try rebalance again."
  }
]
        </pre>

      </div>

    </div>

  </div>

  
  <div class="topic reference nested1" id="rest-cluster-rebalance-adjustduringcompaction">
    <h2 class="title topictitle2">Adjusting rebalance during compaction</h2>

    <div class="body refbody">
      
      <div class="section"><h3 class="title sectiontitle">Description</h3>
        
        <p class="p">If a rebalance is performed
          while a node is undergoing index compaction, rebalance delays may be experienced. The
          parameter, <samp class="ph codeph">rebalanceMovesBeforeCompaction</samp>, is used to improve rebalance
          performance. If this selection is made, index compaction performance is reduced which can
          result in larger index file size.</p>

        
        <p class="p">This needs to be made as POST request to the <samp class="ph codeph">/internalSettings</samp> endpoint.
          By default, this setting is 64 which specifies the number of vBuckets which are moved per
          node until all vBucket movements pauses. After this pause, the system triggers index
          compaction. Index compaction is not performed while vBuckets are being moved, 
          so if a larger value is specified, it means that the server spends less time compacting the index,
          which results in larger index files that take up more disk space.</p>

      </div>


      <div class="section"><h3 class="title sectiontitle">HTTP method and URI</h3>
        
        <pre class="pre codeblock">
POST /internalSettings rebalanceMovesBeforeCompaction
        </pre>
</div>

        
        <div class="section"><h3 class="title sectiontitle">Syntax</h3>
          <p class="p">Curl request syntax:</p>

          <pre class="pre codeblock">curl -X POST -u admin:password 'http://[localhost]:8091/internalSettings' 
    -d 'rebalanceMovesBeforeCompaction=[value]'
</pre>

          
        </div>

      
      <div class="section"><h3 class="title sectiontitle">Example</h3>
      <p class="p">Curl request example:</p>

      <pre class="pre codeblock">curl -X POST -u admin:password 'http://10.5.2.54:8091/internalSettings' 
    -d 'rebalanceMovesBeforeCompaction=256'
</pre>

     
      
    </div>

  </div>

  </div>





</body>
</html>